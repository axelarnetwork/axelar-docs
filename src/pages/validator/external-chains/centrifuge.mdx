# Centrifuge

import { Callout } from "../../../components/callout"

Set up your Centrifuge Mainnet or Testnet node.

## Prerequisites

- [Setup your Axelar validator](/validator/setup)
- Minimum hardware requirements: 2+ cores CPU, 4GB+ RAM, 200GB+ free storage space.
- Recommended hardware: 4+ CPU cores, 16GB RAM, 500GB SSD or faster storage.
- [Releases](https://github.com/centrifuge/centrifuge-chain/releases)
- Docker OR `rustup` is installed

### Optional: Using a snapshot from the Centrifuge dev team
-> This will make your node pretty much ready to receive requests in within hours rather than days.

  Using Centrifuge provided snapshots (faster)
    ```
    gsutil ls gs://centrifuge-snapshots/{mainnet,testnet-demo}
    # Download the bundle
    gsutil cp gs://centrifuge-snapshots/mainnet/YYYY-MM-DD-snap.tar.lz4 $DATA_FOLDER_PATH/
    lz4 -d -c -q  $DATA_FOLDER_PATH/YYYY-MM-DD-snap.tar.lz4 | tar -xvf - -C /path/to/destination
    ```
   Inspect the /path/to/destination, it should contain a 'chain' and a 'relay-chain' directory, the parachain and relay chain 
   DB data folders repectively. Use /path/to/destination on your node config as --base-path=/path/to/destination directly
   Remove the `chain` directory to sync the parachain from scratch but keep the relay DB (usually much bigger)
  

## Options
1. Run with Docker
2. Run with binaries

## 1. Run with Docker

You can use the container published by Centrifuge on their [DockerHub repo](https://hub.docker.com/repository/docker/centrifugeio/centrifuge-chain/tags?page=1&ordering=last_updated)
or be fully trustless by cloning the [cent-chain repository(https://github.com/centrifuge/centrifuge-chain/)]
and using the [Dockerfile](https://github.com/centrifuge/centrifuge-chain/blob/main/Dockerfile) (2-4h build time in an average machine),
in the latter make sure to checkout the specific commit for the latest release before building.

To find the latest release go to the [Centrifuge repository](https://github.com/centrifuge/centrifuge-chain/releases), 
and look for the listed Docker Image.

More images in the official [Docker Hub repository](https://hub.docker.com/repository/docker/centrifugeio/centrifuge-chain/tags?page=1&ordering=last_updated). 

### Create docker compose file

Create a `docker-compose.yml` file with the following contents.
Change the `ports` based on your network setup. 
Replace `/mnt/my_volume/data` with the volume and/or data folder you want to use.

<tabs>
<tab-item title="Mainnet">
  <pre><code>
  ```Dockerfile
  version: '3'
  services:
    centrifuge:
      container_name: centrifuge-chain
      image: "centrifugeio/centrifuge-chain:main-latest"
      platform: "linux/amd64"
      restart: on-failure
      ports:
        - "30355:30333"
        - "9936:9933"
        - "9946:9944"
      volumes:
        # Mount your biggest drive
        - /mnt/my_volume/data:/data
      command:
      - "--port=30333"
      - "--rpc-port=9933"
      - "--ws-port=9944"
      - "--ws-external"
      - "--unsafe-rpc-external"
      - "--rpc-cors=all"
      - "--pruning=archive"
      - "--chain=centrifuge"
      - "--parachain-id=2031"
      - "--base-path=/data"
      - "--log=main,info"
      - "--execution=wasm"
      - "--wasm-execution=compiled"
      - "--ws-max-connections=5000"
      - "--bootnodes=/ip4/35.198.171.148/tcp/30333/ws/p2p/12D3KooWDXDwSdqi8wB1Vjjs5SVpAfk6neadvNTPAik5mQXqV7jF"
      - "--bootnodes=/ip4/34.159.117.205/tcp/30333/ws/p2p/12D3KooWMspZo4aMEXWBH4UXm3gfiVkeu1AE68Y2JDdVzU723QPc"
      - "--state-cache-size=1"
      - "--name=YOUR-NODE-NAME"
      - "--"
      - "--execution=wasm"
      - "--wasm-execution=compiled"
      - "--chain=polkadot"
      - "--sync=fast"
  ```
  </code></pre>
</tab-item>

<tab-item title="Testnet">
  <pre><code>
  ```Dockerfile
  version: '3'
  services:
    centrifuge:
      container_name: centrifuge-chain
      image: "centrifugeio/centrifuge-chain:main-latest"
      platform: "linux/amd64"
      ports:
        - "30333:30333"
        - "9933:9933"
        - "9944:9944"
      volumes:
        - /mnt/my_volume/data:/data
      command:
        - "--port=30333"
        - "--rpc-port=9933"
        - "--ws-port=9944"
        - "--unsafe-rpc-external"
        - "--rpc-cors=all"
        - "--pruning=archive"
        - "--chain=/resources/demo-spec-raw.json"
        - "--parachain-id=2031"
        - "--base-path=/data"
        - "--log=main,info"
        - "--execution=wasm"
        - "--wasm-execution=compiled"
        - "--ws-max-connections=5000"
        - "--bootnodes=/ip4/34.89.150.73/tcp/30333/p2p/12D3KooWHsA69Fb1HkdWrwrxY3cSga3wWyHnxuk5GeYtCh59XsWB"
        - "--bootnodes=/ip4/35.198.144.90/tcp/30333/p2p/12D3KooWMJPzvEp5Jhea8eKsUDufBbAzGrn265GcaCmcnp3koPk4"
        - "--"
        - "--no-telemetry"
        - "--execution=wasm"
        - "--wasm-execution=compiled"
        - "--chain=/resources/westend-alphanet-raw-specs.json"
        - "--sync=fast"
  ```
  </code></pre>
</tab-item>
</tabs>

### Run the container

```bash
docker-compose pull --policy always && docker-compose up -d
```

## 2. Get or build binaries

<tabs>
<tab-item title="Build your own (Ubuntu)">
  ```bash
  sudo apt-get install cmake pkg-config libssl-dev git clang libclang-dev protobuf-compiler
  git clone https://github.com/centrifuge/centrifuge-chain.git
  cd centrifuge-chain
  git checkout [latest_release]
  RUST_TOOLCHAIN=nightly-2022-11-14 ./scripts/install_toolchain.sh
  cargo build --release
  cp ./target/release/centrifuge-chain /usr/local/sbin/centrifuge-chain
  cp ./res/demo-spec-raw.json /var/lib/centrifuge-testnet/para-spec.json
  cp ./res/westend-alphanet-raw-specs.json /var/lib/centrifuge-testnet/relay-spec.json
  ```
</tab-item>

<tab-item title="Download from the release notes">
Make sure to look at the Centrifuge releases specifically if you want to run a mainnet node.
Otherwise it's ok to use the latest release: https://github.com/centrifuge/centrifuge-chain/releases/

If no centrifuge-chain-bin.zip is present in the release, try the "extract from docker method"
Example:
```
curl https://github.com/centrifuge/centrifuge-chain/releases/download/v0.10.31/centrifuge-chain-bin.zip -o centrifuge-chain.zip
unzip centrifuge-chain.zip
shasum -a 256 --check centrifuge-chain.sha256
  centrifuge-chain: OK
mv centrifuge-chain /usr/local/sbin/centrifuge-chain
```
</tab-item>

<tab-item title="Extract from docker">
Make sure to look at the Centrifuge release specifically if you want to run a mainnet node
```
  docker run --name centrifuge-cp -d centrifugeio/centrifuge-chain:main-latest --chain centrifuge
  docker cp centrifuge-cp:/usr/local/bin/centrifuge-chain /usr/local/sbin/centrifuge-chain
```
</tab-item>
</tabs>

### Configure systemd

##### 1. Create systemd service file
We are now ready to start the node, but to ensure it is running in the background and auto-restarts in case of a server failure, we will set up a service file using systemd.
Change the `ports` based on your network setup.

<tabs>
<tab-item title="Mainnet">
<pre><code>
```bash
useradd centrifuge
chown centrifuge:centrifuge /data

sudo tee <<EOF >/dev/null /etc/systemd/system/centrifuge.service
[Unit]
Description="Centrifuge systemd service"
After=network.target
StartLimitIntervalSec=0

[Service]
Type=simple
Restart=always
RestartSec=10
User=centrifuge
SyslogIdentifier=centrifuge
SyslogFacility=local7
KillSignal=SIGHUP
ExecStart=/usr/local/sbin/centrifuge-chain \
    --port=30333 \
    --rpc-port=9933 \
    --ws-port=9944 \
    --ws-external \
    --unsafe-rpc-external \
    --rpc-cors=all \
    --rpc-methods=unsafe \
    --pruning=archive \
    --chain=centrifuge \
    --parachain-id=2031 \
    --base-path=/data \
    --log=main,info \
    --execution=wasm \
    --wasm-execution=compiled \
    --ws-max-connections=5000 \
    --bootnodes=/ip4/35.198.171.148/tcp/30333/ws/p2p/12D3KooWDXDwSdqi8wB1Vjjs5SVpAfk6neadvNTPAik5mQXqV7jF \
    --bootnodes=/ip4/34.159.117.205/tcp/30333/ws/p2p/12D3KooWMspZo4aMEXWBH4UXm3gfiVkeu1AE68Y2JDdVzU723QPc \
    -- \
    --chain=polkadot \
    --execution=wasm \
    --wasm-execution=compiled \
    --sync=fast

[Install]
WantedBy=multi-user.target
EOF
```
</code></pre>
</tab-item>

<tab-item title="Testnet">

You'll have to download the Relay chain spec first:

<pre><code>
curl -O https://github.com/centrifuge/centrifuge-chain/blob/main/res/westend-alphanet-raw-specs.json 
mv westend-alphanet-raw-specs.json /config/
</code></pre>

<pre><code>
```bash
useradd centrifuge
chown centrifuge:centrifuge /data

git clone https://github.com/centrifuge/centrifuge-chain.git
cd centrifuge-chain
git checkout v.0.10.31 # Check out latest release at https://github.com/centrifuge/centrifuge-chain/releases/
cp ./res/demo-spec-raw.json /config/para-spec.json
cp ./res/westend-alphanet-raw-specs.json /config/relay-spec.json

sudo tee <<EOF >/dev/null /etc/systemd/system/centrifuge.service
[Unit]
Description="Centrifuge Testnet systemd service"
After=network.target
StartLimitIntervalSec=0

[Service]
Type=simple
Restart=always
RestartSec=10
User=centrifuge
SyslogIdentifier=centrifuge_testnet
SyslogFacility=local7
KillSignal=SIGHUP
ExecStart=/usr/local/sbin/centrifuge-chain \
    --port=30333 \
    --rpc-port=9933 \
    --ws-port=9944 \
    --ws-external \
    --unsafe-rpc-external \
    --rpc-cors=all \
    --pruning=archive \
    --chain=/config/para-spec.json \
    --parachain-id=2031 \
    --base-path=/data-testnet/ \
    --log=main,info \
    --execution=wasm \
    --wasm-execution=compiled \
    --bootnodes=/ip4/34.89.150.73/tcp/30333/p2p/12D3KooWHsA69Fb1HkdWrwrxY3cSga3wWyHnxuk5GeYtCh59XsWB \
    --bootnodes=/ip4/35.198.144.90/tcp/30333/p2p/12D3KooWMJPzvEp5Jhea8eKsUDufBbAzGrn265GcaCmcnp3koPk4 \
    -- \
    --no-telemetry \
    --execution=wasm \
    --wasm-execution=compiled \
    --chain=/config/relay-spec.json \
    --sync=fast

[Install]
WantedBy=multi-user.target
EOF
```
</code></pre>
</tab-item>
</tabs>



##### 2. Start the systemd service
Actually enable the previously generated service and start it.

```bash
sudo systemctl enable centrifuge.service
sudo systemctl start centrifuge.service
```

If everything was set-up correctly, your node should now be starting the process of synchronization.
This will take several hours, depending on your hardware. To check the status of the running service or to follow the logs, use:

```bash
sudo systemctl status centrifuge.service
sudo journalctl -u centrifuge.service -f
```


##### 3. Test your RPC connection

Once your node is fully synced, you can run a cURL request to see the status of your node, use
the port you configured in your /etc/systemd/system/centrifuge.service file avobe

```bash
curl -H "Content-Type: application/json" \
-d '{{"id":1, "jsonrpc":"2.0", "method": "eth_syncing", "params":[]}}' \
localhost:9933
```

Expected output if node is synced is `{"jsonrpc":"2.0","result":false,"id":1}`

### Configure `vald`

In order for `vald` to connect to your local node, your `rpc_addr` should be exposed in
`vald`'s `config.toml`

```bash
[[axelar_bridge_evm]]
name = "centrifuge"
rpc_addr = "http://IP:PORT"
start-with-bridge = true
```

