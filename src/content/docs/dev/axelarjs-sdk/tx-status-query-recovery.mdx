# Programmatically query and recover GMP transactions

import { Callout } from "/src/components/callout"

Transactions can occasionally get stuck in the pipeline from a source to destination chain, mostly for one of the two following reasons:

- The transaction is not relayed from the source chain into the Axelar network for processing.
- The transaction fails to get executed on the destination chain.

The [`AxelarGMPRecoveryAPI`](https://github.com/axelarnetwork/axelarjs-sdk/blob/main/src/libs/TransactionRecoveryApi/AxelarGMPRecoveryAPI.ts) module in the AxelarJS SDK can be used to troubleshoot:

- Query the status of any General Message Passing (GMP) transaction for either `callContract()` or `callContractWithToken()` on the gateway contract of a source chain.
- Trigger a manual relay from the source chain to the destination chain.

<Callout>
Transaction recovery can also be invoked through the [Axelarscan UI](/dev/general-message-passing/debug/transaction-recovery/).
</Callout>

## Install the `AxelarGMPRecoveryAPI` module

Install the AxelarJS SDK:

```bash
npm i @axelar-network/axelarjs-sdk
```

Instantiate the [`AxelarGMPRecoveryAPI`](https://github.com/axelarnetwork/axelarjs-sdk/blob/main/src/libs/TransactionRecoveryApi/AxelarGMPRecoveryAPI.ts) module:

```ts
import {
  AxelarGMPRecoveryAPI,
  Environment,
} from "@axelar-network/axelarjs-sdk";

const sdk = new AxelarGMPRecoveryAPI({
  environment: Environment.TESTNET,
});
```

## Query transaction status by `txHash`

See the status of a transaction by passing its `txHash` into [`queryTransactionStatus()`](https://github.com/axelarnetwork/axelarjs-sdk/blob/86bc55224f84f9539dd109e5dfd6b443a116eebe/src/libs/TransactionRecoveryApi/AxelarRecoveryApi.ts#L226):

```ts
const txHash: string =
  "0xfb6fb85f11496ef58b088116cb611497e87e9c72ff0c9333aa21491e4cdd397a";
const eventIndex: number = 97
const txStatus: GMPStatusResponse = await sdk.queryTransactionStatus(txHash, eventIndex);
```

The following are possible status responses:

```ts
interface GMPStatusResponse {
  status: GMPStatus | string;
  timeSpent?: Record<string, number>;
  gasPaidInfo?: GasPaidInfo;
  error?: GMPError;
  callTx?: any;
  executed?: any;
  expressExecuted?: any;
  approved?: any;
  callback?: any;
}

enum GMPStatus {
  SRC_GATEWAY_CALLED = "source_gateway_called",
  DEST_GATEWAY_APPROVED = "destination_gateway_approved",
  DEST_EXECUTED = "destination_executed",
  EXPRESS_EXECUTED = "express_executed",
  DEST_EXECUTE_ERROR = "error",
  DEST_EXECUTING = "executing",
  APPROVING = "approving",
  FORECALLED = "forecalled",
  FORECALLED_WITHOUT_GAS_PAID = "forecalled_without_gas_paid",
  NOT_EXECUTED = "not_executed",
  NOT_EXECUTED_WITHOUT_GAS_PAID = "not_executed_without_gas_paid",
  INSUFFICIENT_FEE = "insufficient_fee",
  UNKNOWN_ERROR = "unknown_error",
  CANNOT_FETCH_STATUS = "cannot_fetch_status",
  SRC_GATEWAY_CONFIRMED = "confirmed"
}

interface GasPaidInfo {
  status: GasPaidStatus;
  details?: any;
}

enum GasPaidStatus {
  GAS_UNPAID = "gas_unpaid",
  GAS_PAID = "gas_paid",
  GAS_PAID_NOT_ENOUGH_GAS = "gas_paid_not_enough_gas",
  GAS_PAID_ENOUGH_GAS = "gas_paid_enough_gas",
}
```

## Manually relay the transaction through the Axelar network

Use [`manualRelayToDestChain()`](https://github.com/axelarnetwork/axelarjs-sdk/blob/86bc55224f84f9539dd109e5dfd6b443a116eebe/src/libs/TransactionRecoveryApi/AxelarGMPRecoveryAPI.ts#L453) to manually relay a transaction to the destination chain through the Axelar network. It will query the current transaction status and recover from source to destination if needed.

```ts
const sourceTxHash = "0x..";
const provider = new ethers.providers.JsonRpcProvider(
  "https://goerli.infura.io/v3/projectId"
);

// Optional
// By default, The sdk uses `window.ethereum` wallet as a sender wallet e.g. MetaMask.
// This option allows caller to pass `privateKey` or `provider` to the sdk directly
const senderOptions = { privateKey: "0x", provider };

const response = await sdk.manualRelayToDestChain(
  sourceTxHash,
  senderOptions /* can be skipped */
);
```

Possible response values are:

```ts
export interface GMPRecoveryResponse {
  success: boolean;
  error?: ApproveGatewayError | string;
  confirmTx?: AxelarTxResponse;
  signCommandTx?: AxelarTxResponse;
  routeMessageTx?: AxelarTxResponse;
  approveTx?: any;
  infoLogs?: string[];
}
```

If `success == false`, you can either execute the transaction manually or increase the gas payment.

## Manually execute a transaction

When invoking this method, you will manually execute and pay for the executable method on your specified contract on the destination chain of your cross-chain transaction.

```ts
const sourceTxHash = "0x..";
const provider = new ethers.providers.JsonRpcProvider(
  "https://goerli.infura.io/v3/projectId"
);

// Optional
// By default, The sdk uses `window.ethereum` wallet as a sender wallet e.g. MetaMask.
// This option allows caller to pass `privateKey` or `provider` to the sdk directly
const senderOptions = { privateKey: "0x", provider };

const response = await sdk.execute(
  sourceTxHash,
  senderOptions /* can be skipped */
);
```

Possible response values are:

```ts
{
    success: "success" | "failed",
    data: ethers.ContractReceipt | undefined,
    error: string | undefined
}
```

## Increase gas payment

Call `addNativeGas()` to increase the gas payment using the source chain's native token. The amount to be added will be automatically calculated based on factors such as the token price of the source and destination chains and the current gas price at the destination chain. This can be overridden by specifying the amount in the `options`.

```ts
import {
  AxelarGMPRecoveryAPI,
  Environment,
  AddGasOptions,
} from "@axelar-network/axelarjs-sdk";

// Optional
const options: AddGasOptions = {
  amount: "10000000", // Amount of gas to be added. If not specified, the sdk will calculate the amount automatically.
  refundAddress: "", // If not specified, the default value is the sender address.
  estimatedGasUsed: 700000, // An amount of gas to execute `executeWithToken` or `execute` function of the custom destination contract. If not specified, the default value is 700000.
  evmWalletDetails: { useWindowEthereum: true, privateKey: "0x" }, // A wallet to send an `addNativeGas` transaction. If not specified, the default value is { useWindowEthereum: true}.
};

const txHash: string = "0x...";
const { success, transaction, error } = await api.addNativeGas(
  EvmChain.AVALANCHE,
  txHash,
  estimatedGasUsed,
  options
);

if (success) {
  console.log("Added native gas tx:", transaction?.transactionHash);
} else {
  console.log("Cannot add native gas", error);
}
```

Possible response values are:

```ts
{
    success: "success" | "failed",
    data: ethers.ContractReceipt | undefined,
    error: string | undefined
}
```
